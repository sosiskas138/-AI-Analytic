# Оптимизация проекта

## Выполненные оптимизации

### 1. Фильтрация ГЦК на уровне бэкенда

**Проблема:** ГЦК страницы показывали все данные проекта, а не только данные ГЦК поставщиков.

**Решение:**
- Добавлен параметр `isGck` в endpoints:
  - `GET /api/suppliers/project/:projectId?isGck=true` - фильтрация ГЦК поставщиков
  - `GET /api/suppliers/project/:projectId/numbers?isGck=true` - фильтрация номеров ГЦК поставщиков
  - `GET /api/calls/project/:projectId?isGck=true` - фильтрация звонков по номерам ГЦК поставщиков

- Фильтрация выполняется на уровне SQL запросов для лучшей производительности

### 2. Оптимизация запросов данных

**Изменения:**
- Добавлено кэширование (`staleTime: 30000`) для часто используемых запросов
- Устранено дублирование запросов `suppliers` в `ProjectDashboard.tsx`
- Запросы теперь используют общий кэш React Query

### 3. Исправлена логика ГЦК

**Страницы, использующие только ГЦК данные:**
- `ProjectReport.tsx` (ГЦК) - показывает только звонки и номера ГЦК поставщиков
- `ProjectSuppliersGCK.tsx` (Базы) - показывает только ГЦК поставщики и их статистику
- `ProjectDashboard.tsx` - секция ГЦК показывает только данные ГЦК

**Импорт ГЦК:**
- При импорте с типом `gck` автоматически помечает поставщика как `is_gck = true`
- Номера и звонки связываются только с ГЦК поставщиками

### 4. Улучшена производительность

**Оптимизации:**
- Фильтрация на уровне БД вместо клиентской фильтрации
- Кэширование запросов на 30 секунд
- Устранено дублирование запросов
- Оптимизированы SQL запросы с JOIN для фильтрации ГЦК

## Технические детали

### Бэкенд изменения

1. **`backend/src/routes/suppliers.ts`:**
   - Добавлена фильтрация по `isGck` в `GET /project/:projectId`
   - Добавлена фильтрация по `isGck` в `GET /project/:projectId/numbers` с JOIN к таблице suppliers

2. **`backend/src/routes/calls.ts`:**
   - Добавлена фильтрация по `isGck` с использованием EXISTS подзапроса для проверки принадлежности номера к ГЦК поставщику

### Фронтенд изменения

1. **`src/lib/api.ts`:**
   - Добавлен параметр `isGck` в методы `getSuppliers()`, `getSupplierNumbers()`, `getCalls()`

2. **`src/pages/ProjectReport.tsx`:**
   - Использует `isGck: true` для всех запросов данных

3. **`src/pages/ProjectSuppliersGCK.tsx`:**
   - Использует `isGck: true` для всех запросов данных
   - Фильтрация поставщиков выполняется на бэкенде

4. **`src/pages/ProjectDashboard.tsx`:**
   - Секция ГЦК фильтрует данные по ГЦК поставщикам на клиенте
   - Устранено дублирование запроса suppliers

## Результаты

✅ ГЦК страницы показывают только данные ГЦК поставщиков
✅ Импорт ГЦК правильно помечает данные
✅ Улучшена производительность за счет фильтрации на уровне БД
✅ Добавлено кэширование для часто используемых запросов
✅ Устранено дублирование запросов
